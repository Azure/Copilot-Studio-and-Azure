# Lab 1.3: Integrate Model Context Protocol (MCP) in Copilot Studio

## Objectives
By the end of this lab, you will be able to:
- Add and configure the Model Context Protocol (MCP) tool in Copilot Studio
- Connect to Microsoft Dataverse using OpenAPI MCP server
- Test and validate your agent’s ability to read and write real-time Dataverse data

## Prerequisites

It's required to have completed **[Lab 0.0 - Create an agent](../0.0-create-an-agent/0.0-create-an-agent.md)** to follow this part.

## Overview

This lab walks you through integrating the Model Context Protocol (MCP) with a Copilot Studio agent. You will learn how MCP works, when to use it, and how it simplifies real-time access to external systems such as Microsoft Dataverse.
- Estimated completion time: 30 minutes

## What is MCP?
Think of MCP as a universal adapter for AI agents.
It provides a standardized way for copilots and models to access:
- External APIs
- Data sources
- Existing tools
- Knowledge bases
Using MCP, you can plug multiple data or capability providers into your agent without writing custom integration code.


## Task 1: Add the MCP Tool

1. Open your agent in Copilot Studio.
2. Go to the **Tools** section.

![](./images/Image1.png)

3. Select **+ Add a tool**.

![](./images/Image2.png)

4. Search for **Model Context Protocol**.

![](./images/Image3.png)

5. Choose **Dataverse MCP Server** from the list.

![](./images/Image4.png)

6. Click **Add and configure**.

![](./images/Image5.png)

---
Optional: If you want to bring your own server, Copilot Studio allows you to add a custom MCP server: https://learn.microsoft.com/en-us/microsoft-copilot-studio/mcp-add-existing-server-to-agent

## Task 2: Connect to Dataverse

After adding the Dataverse MCP Server:
1.	Choose the Dataverse environment you want to connect to.
2.	Review the list of available tables and operations.
3.	Select the entities (tables) the agent should access, for example:
- Contacts
- Accounts
- Leads
4.	Save and apply the configuration.
This step defines what actions the agent can perform based on the MCP server’s exposed capabilities.


## Task 3: Test Your Agent

1. Open the **Test your agent** pane.

![](./images/Image6.png)

2. Try the following queries:
   - “Show me my contacts.” (READ from Dataverse)
   - “Create a new lead with name John Doe.” (WRITE to Dataverse)
   - “Show me all leads created this week.” (more complex READ actions)
   - “Update the status of lead John Doe to Qualified.” (more complex WRITE actions)
3.	Confirm that the agent retrieves data or performs actions in real time.

This validates that the MCP integration is active and functional.

---


## What MCP Is Doing

- MCP translates the natural language request into an API call
- Matches intent → finds matching MCP tool action
- Executes the OpenAPI operation defined by the server
- Sends structured JSON to Dataverse
- Returns results to Copilot Studio in a standardized format

<img width="975" height="71" alt="image" src="https://github.com/user-attachments/assets/a1f14fb4-7920-40c1-a122-52ff7ae38374" />


---

## How Authentication Works Between Copilot Studio and the MCP Server

Communication between Copilot Studio and the MCP server is authenticated using Microsoft Entra ID (formerly Azure AD).
Step-by-step authentication flow
1.	Copilot Studio authenticates the agent using the user’s identity or the agent’s service identity (depending on how the agent is invoked).
2.	The MCP client in Copilot Studio sends requests to the MCP server with a valid OAuth 2.0 access token.
3.	The MCP server validates the token:
   - Checks tenant
   - Verifies app registration / resource scope
   - Confirms permissions
4.	Only then does the MCP server call the Dataverse API using its own identity and assigned permissions.

Important
- MCP servers do not use stored usernames or passwords.
- All access is token-based and fully governed by Entra ID and Dataverse security.


## Troubleshooting Scenarios
| Issue | Likely Cause | Fix |
|------|-------------|-----|
| Agent says “No tool found to execute this action” | MCP Server not selected or configured | Re-select server and expose the table again |
| Agent returns no records | Dataverse table has no sample data | Add test rows to Dataverse |
| Writes fail | Missing Dataverse permissions | Check environment and table security |
| User intent not recognized | Missing metadata/synonyms | Improve Dataverse schema descriptions |



---
## Tips for Success

### Metadata Matters
- Use clear table names and descriptions in Dataverse.
- Add synonyms and definitions to improve natural language understanding.


### Centralised MCP Server
- Reuse a single MCP server across multiple agents.
- Only duplicate if isolation is required.

### Limitations
There are some known issues and planned improvements for MCP in Microsoft Copilot Studio. They are listed in this [Microsoft Learn article](https://learn.microsoft.com/en-us/microsoft-copilot-studio/agent-extend-action-mcp#known-issues--planned-improvements).

## Training Resources
- [Connect to Dataverse with MCP](https://learn.microsoft.com/en-us/power-apps/maker/data-platform/data-platform-mcp)
- [MCP in Copilot Studio Explained](https://www.youtube.com/watch?v=EYQqgLoYSNM)
- [Copilot Studio MCP Catalog](https://learn.microsoft.com/en-us/microsoft-copilot-studio/agent-extend-action-mcp)


